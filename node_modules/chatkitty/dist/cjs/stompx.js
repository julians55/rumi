"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
var rx_stomp_1 = require("@stomp/rx-stomp");
var stompjs_1 = require("@stomp/stompjs");
var axios_1 = __importDefault(require("axios"));
var operators_1 = require("rxjs/operators");
var uuid_1 = require("uuid");
var version_1 = require("./environment/version");
var TransportFallback;
Promise.resolve().then(function () { return __importStar(require('sockjs-client')); }).then(function (sockjs) {
    TransportFallback = sockjs;
})
    .catch(function (error) {
    ErrorMessageTransportFallback.errorMessage = error.message;
    TransportFallback = { default: ErrorMessageTransportFallback };
});
var ErrorMessageTransportFallback = /** @class */ (function () {
    function ErrorMessageTransportFallback() {
        throw new Error('Encountered error when attempting to use transport fallback: ' +
            ErrorMessageTransportFallback.errorMessage);
    }
    return ErrorMessageTransportFallback;
}());
var StompX = /** @class */ (function () {
    function StompX(configuration) {
        this.topics = new Map();
        this.pendingActions = new Map();
        this.pendingRelayErrors = new Map();
        this.pendingActionErrors = new Map();
        this.eventHandlers = new Map();
        this.rxStomp = new rx_stomp_1.RxStomp();
        this.initialized = false;
        this.host = configuration.host;
        if (configuration.isSecure) {
            this.wsScheme = 'wss';
            this.httpScheme = 'https';
        }
        else {
            this.wsScheme = 'ws';
            this.httpScheme = 'http';
        }
        this.rxStompConfig = {
            stompVersions: new stompjs_1.Versions(['1.2']),
            connectionTimeout: 60000,
            heartbeatIncoming: 10000,
            heartbeatOutgoing: 60000,
            debug: function (message) {
                if (configuration.isDebug) {
                    console.log('StompX Debug:\n' + message);
                }
            },
        };
        if (typeof navigator != 'undefined' && navigator.product == 'ReactNative') {
            this.rxStompConfig.forceBinaryWSFrames = true;
            this.rxStompConfig.appendMissingNULLonIncoming = true;
        }
        this.axios = axios_1.default.create({
            baseURL: this.httpScheme + '://' + this.host,
        });
    }
    StompX.prototype.connect = function (request) {
        var _this = this;
        var host = this.host;
        var connectHeaders = {
            'StompX-User': request.username,
            'StompX-User-Agent': "ChatKitty-JS/" + version_1.version,
        };
        if (request.authParams) {
            connectHeaders['StompX-Auth-Params'] = btoa(JSON.stringify(request.authParams));
        }
        if (typeof WebSocket === 'function') {
            this.rxStompConfig.brokerURL = this.wsScheme + "://" + host + "/rtm/websocket?api-key=" + encodeURIComponent(request.apiKey);
        }
        else {
            this.rxStompConfig.webSocketFactory = function () {
                return new TransportFallback.default(_this.httpScheme + "://" + host + "/rtm?api-key=" + encodeURIComponent(request.apiKey));
            };
        }
        this.rxStomp.configure(__assign(__assign({}, this.rxStompConfig), { connectHeaders: connectHeaders }));
        this.rxStomp.serverHeaders$.subscribe(function (headers) {
            _this.rxStomp.configure(__assign(__assign({}, _this.rxStompConfig), { connectHeaders: __assign(__assign({}, connectHeaders), { 'StompX-Auth-Session-ID': headers['session'] }) }));
        });
        this.rxStomp.connected$.subscribe(function () {
            _this.relayResource({
                destination: '/application/v1/user.relay',
                onSuccess: function (user) {
                    if (_this.initialized) {
                        request.onConnected(user);
                    }
                    else {
                        _this.rxStomp
                            .watch('/user/queue/v1/errors', {
                            id: StompX.generateSubscriptionId(),
                        })
                            .subscribe(function (message) {
                            var error = JSON.parse(message.body);
                            var subscription = message.headers['subscription-id'];
                            var receipt = message.headers['receipt-id'];
                            if (subscription) {
                                var handler = _this.pendingRelayErrors.get(subscription);
                                if (handler) {
                                    handler(error);
                                    _this.pendingRelayErrors.delete(subscription);
                                }
                            }
                            if (receipt) {
                                var handler = _this.pendingActionErrors.get(receipt);
                                if (handler) {
                                    handler(error);
                                    _this.pendingActionErrors.delete(receipt);
                                }
                            }
                            if (!subscription && !receipt) {
                                _this.pendingActionErrors.forEach(function (handler) {
                                    handler(error);
                                });
                                _this.pendingActionErrors.clear();
                            }
                        });
                        _this.relayResource({
                            destination: '/application/v1/user.write_file_access_grant.relay',
                            onSuccess: function (write) {
                                _this.relayResource({
                                    destination: '/application/v1/user.read_file_access_grant.relay',
                                    onSuccess: function (read) {
                                        request.onSuccess(user, write.grant, read.grant);
                                        request.onConnected(user);
                                        _this.initialized = true;
                                    },
                                });
                            },
                        });
                    }
                },
            });
        });
        this.rxStomp.connectionState$.subscribe(function (state) {
            if (state == rx_stomp_1.RxStompState.CLOSED) {
                request.onConnectionLost();
            }
            if (state == rx_stomp_1.RxStompState.OPEN) {
                request.onConnectionResumed();
            }
        });
        this.rxStomp.stompErrors$.subscribe(function (frame) {
            var error;
            try {
                error = JSON.parse(frame.body);
            }
            catch (e) {
                error = {
                    error: 'UnknownChatKittyError',
                    message: 'An unknown error occurred.',
                    timestamp: new Date().toISOString(),
                };
            }
            if (error.error == 'AccessDeniedError') {
                var onResult = function () { return request.onError(error); };
                _this.disconnect({ onSuccess: onResult, onError: onResult });
            }
            else {
                request.onError(error);
            }
        });
        this.rxStomp.webSocketErrors$.subscribe(function (error) {
            console.error(error);
            request.onError({
                error: 'ChatKittyConnectionError',
                message: 'Could not connect to ChatKitty',
                timestamp: new Date().toISOString(),
            });
        });
        this.rxStomp.activate();
    };
    StompX.prototype.relayResource = function (request) {
        var _this = this;
        this.guardConnected(function () {
            var subscriptionId = StompX.generateSubscriptionId();
            if (request.onError) {
                _this.pendingRelayErrors.set(subscriptionId, request.onError);
            }
            _this.rxStomp.stompClient.subscribe(request.destination, function (message) {
                request.onSuccess(JSON.parse(message.body).resource);
            }, __assign(__assign({}, request.parameters), { id: subscriptionId }));
        });
    };
    StompX.prototype.listenToTopic = function (request) {
        var _this = this;
        var unsubscribe = function () {
            // Do nothing
        };
        this.guardConnected(function () {
            var subscriptionReceipt = StompX.generateReceipt();
            var onSuccess = request.onSuccess;
            if (onSuccess) {
                _this.rxStomp.watchForReceipt(subscriptionReceipt, function () {
                    onSuccess();
                });
            }
            var subscription = _this.rxStomp
                .watch(request.topic, {
                id: StompX.generateSubscriptionId(),
                receipt: subscriptionReceipt,
                ack: 'client-individual',
            })
                .subscribe(function (message) {
                var event = JSON.parse(message.body);
                var receipt = message.headers['receipt-id'];
                if (receipt) {
                    var action = _this.pendingActions.get(receipt);
                    if (action && (!action.types || action.types.find(function (type) { return type === event.type; }))) {
                        action.action(event.resource);
                        _this.pendingActions.delete(receipt);
                    }
                }
                var handlers = _this.eventHandlers.get(request.topic);
                if (handlers) {
                    handlers.forEach(function (handler) {
                        if (handler.event === event.type) {
                            handler.onSuccess(event.resource);
                        }
                    });
                }
                message.ack();
            });
            _this.topics.set(request.topic, subscription);
            unsubscribe = function () {
                subscription.unsubscribe();
                _this.topics.delete(request.topic);
            };
        });
        return function () { return unsubscribe(); };
    };
    StompX.prototype.listenForEvent = function (request) {
        var handlers = this.eventHandlers.get(request.topic);
        if (handlers === undefined) {
            handlers = new Set();
        }
        var handler = {
            event: request.event,
            onSuccess: request.onSuccess,
        };
        handlers.add(handler);
        this.eventHandlers.set(request.topic, handlers);
        return function () {
            if (handlers) {
                handlers.delete(handler);
            }
        };
    };
    StompX.prototype.sendAction = function (request) {
        var _this = this;
        this.guardConnected(function () {
            var receipt = StompX.generateReceipt();
            if (request.onSent) {
                _this.rxStomp.watchForReceipt(receipt, request.onSent);
            }
            if (request.onSuccess) {
                _this.pendingActions.set(receipt, {
                    types: request.events,
                    action: request.onSuccess
                });
            }
            if (request.onError) {
                _this.pendingActionErrors.set(receipt, request.onError);
            }
            _this.rxStomp.publish({
                destination: request.destination,
                headers: {
                    'content-type': 'application/json;charset=UTF-8',
                    receipt: receipt,
                },
                body: JSON.stringify(request.body),
            });
        });
    };
    StompX.prototype.sendToStream = function (request) {
        var _a, _b, _c;
        var data = new FormData();
        var file = request.file;
        if (!(file instanceof File)) {
            file = StompX.dataUriToFile(file.uri, file.name);
        }
        data.append('file', file);
        (_a = request.properties) === null || _a === void 0 ? void 0 : _a.forEach(function (value, key) {
            data.append(key, JSON.stringify(value));
        });
        (_c = (_b = request.progressListener) === null || _b === void 0 ? void 0 : _b.onStarted) === null || _c === void 0 ? void 0 : _c.call(_b);
        this.axios({
            method: 'post',
            url: request.stream,
            data: data,
            headers: { 'Content-Type': 'multipart/form-data', Grant: request.grant },
            onUploadProgress: function (progressEvent) {
                var _a, _b;
                (_b = (_a = request.progressListener) === null || _a === void 0 ? void 0 : _a.onProgress) === null || _b === void 0 ? void 0 : _b.call(_a, progressEvent.loaded / progressEvent.total);
            },
        })
            .then(function (response) {
            var _a, _b, _c;
            (_b = (_a = request.progressListener) === null || _a === void 0 ? void 0 : _a.onCompleted) === null || _b === void 0 ? void 0 : _b.call(_a);
            (_c = request.onSuccess) === null || _c === void 0 ? void 0 : _c.call(request, response.data);
        })
            .catch(function (error) {
            var _a, _b, _c;
            (_b = (_a = request.progressListener) === null || _a === void 0 ? void 0 : _a.onFailed) === null || _b === void 0 ? void 0 : _b.call(_a);
            (_c = request.onError) === null || _c === void 0 ? void 0 : _c.call(request, error);
        });
    };
    StompX.prototype.disconnect = function (request) {
        this.initialized = false;
        this.rxStomp.deactivate().then(request.onSuccess).catch(request.onError);
        this.rxStomp = new rx_stomp_1.RxStomp();
    };
    StompX.prototype.guardConnected = function (action) {
        this.rxStomp.connected$.pipe((0, operators_1.take)(1)).subscribe(function () {
            action();
        });
    };
    StompX.dataUriToFile = function (url, name) {
        var _a;
        var arr = url.split(','), mime = (_a = arr[0].match(/:(.*?);/)) === null || _a === void 0 ? void 0 : _a[1], bstr = atob(arr[1]);
        var n = bstr.length;
        var u8arr = new Uint8Array(n);
        while (n--) {
            u8arr[n] = bstr.charCodeAt(n);
        }
        return new File([u8arr], name, { type: mime });
    };
    StompX.generateSubscriptionId = function () {
        return 'subscription-id-' + (0, uuid_1.v4)();
    };
    StompX.generateReceipt = function () {
        return 'receipt-' + (0, uuid_1.v4)();
    };
    return StompX;
}());
exports.default = StompX;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvbXB4LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3N0b21weC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDRDQUFxRTtBQUNyRSwwQ0FBc0Q7QUFDdEQsZ0RBQTJDO0FBRTNDLDRDQUFvQztBQUNwQyw2QkFBd0I7QUFFeEIsaURBQThDO0FBRTlDLElBQUksaUJBQTZELENBQUM7QUFFbEUsaUVBQU8sZUFBZSxPQUNuQixJQUFJLENBQUMsVUFBQyxNQUFNO0lBQ1gsaUJBQWlCLEdBQUcsTUFBTSxDQUFDO0FBQzdCLENBQUMsQ0FBQztLQUNELEtBQUssQ0FBQyxVQUFDLEtBQUs7SUFDWCw2QkFBNkIsQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQztJQUUzRCxpQkFBaUIsR0FBRyxFQUFDLE9BQU8sRUFBRSw2QkFBNkIsRUFBQyxDQUFDO0FBQy9ELENBQUMsQ0FBQyxDQUFDO0FBRUw7SUFHRTtRQUNFLE1BQU0sSUFBSSxLQUFLLENBQ2IsK0RBQStEO1lBQy9ELDZCQUE2QixDQUFDLFlBQVksQ0FDM0MsQ0FBQztJQUNKLENBQUM7SUFDSCxvQ0FBQztBQUFELENBQUMsQUFURCxJQVNDO0FBRUQ7SUFnQ0UsZ0JBQVksYUFBa0M7UUFyQjdCLFdBQU0sR0FBOEIsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUU5QyxtQkFBYyxHQUl4QixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBRUEsdUJBQWtCLEdBQ0QsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUUzQix3QkFBbUIsR0FDRixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBRTNCLGtCQUFhLEdBQ1EsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUV4QyxZQUFPLEdBQVksSUFBSSxrQkFBTyxFQUFFLENBQUM7UUFFbEMsZ0JBQVcsR0FBRyxLQUFLLENBQUM7UUFHekIsSUFBSSxDQUFDLElBQUksR0FBRyxhQUFhLENBQUMsSUFB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